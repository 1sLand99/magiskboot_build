find_program(RUSTC_EXECUTABLE rustc REQUIRED)
execute_process(
    COMMAND ${RUSTC_EXECUTABLE} -Vv
    OUTPUT_VARIABLE "RUSTC_OUTPUT"
    ERROR_QUIET
    OUTPUT_STRIP_TRAILING_WHITESPACE
)
string(REPLACE "\n" ";" RUSTC_OUTPUT ${RUSTC_OUTPUT})
foreach(RUSTC_OUTPUT_LINE ${RUSTC_OUTPUT})
    string(REGEX REPLACE "^[ ]+" "" RUSTC_OUTPUT_LINE ${RUSTC_OUTPUT_LINE})
    if (RUSTC_OUTPUT_LINE STREQUAL "")
        continue()
    else()
        if (RUSTC_OUTPUT_LINE MATCHES "^rustc[ \t]+")
            string(REGEX MATCH "[0-9]+\\.[0-9]+\\.[0-9]+" RUSTC_VERSION ${RUSTC_OUTPUT_LINE})
        elseif (RUSTC_OUTPUT_LINE MATCHES "^host:[ \t]+")
            string(REGEX REPLACE "^host:[ \t]+" "" HOST_RUSTC_TARGET ${RUSTC_OUTPUT_LINE})
            message(STATUS "Host Rust target: ${HOST_RUSTC_TARGET}")
            if (NOT RUSTC_TARGET)
                set(RUSTC_TARGET "${HOST_RUSTC_TARGET}")
            endif()
        endif()
    endif()
endforeach()
if (NOT DEFINED RUSTC_VERSION)
    set(RUSTC_VERSION "unknown")
endif()
message(STATUS "Found rustc: ${RUSTC_EXECUTABLE} (version ${RUSTC_VERSION})")
if (RUSTC_TARGET)
    message(STATUS "Rust target: ${RUSTC_TARGET}")
else()
    message(FATAL_ERROR "Rust target cannot be detected")
endif()
find_program(CARGO_EXECUTABLE cargo REQUIRED)
execute_process(
    COMMAND ${CARGO_EXECUTABLE} -V
    OUTPUT_VARIABLE "CARGO_VERSION"
    ERROR_QUIET
    OUTPUT_STRIP_TRAILING_WHITESPACE
)
if (CARGO_VERSION MATCHES "^cargo[ \t]+")
    string(REGEX REPLACE "^cargo[ \t]+" "" CARGO_VERSION ${CARGO_VERSION})
else()
    set(CARGO_VERSION "unknown")
endif()
message(STATUS "Found cargo: ${CARGO_EXECUTABLE}, version ${CARGO_VERSION}")

if (CMAKE_BUILD_TYPE MATCHES "Debug")
    set(CARGO_OUT "debug")
else()
    set(CARGO_FLAGS ${CARGO_FLAGS} -r)
    set(CARGO_OUT "release")
endif()

if (CMAKE_BUILD_TYPE MATCHES "MinSize")
    set(RUSTFLAGS "${RUSTFLAGS} -Copt-level=z")
endif()

if (CMAKE_BUILD_TYPE MATCHES "WithDebInfo")
    set(RUSTFLASG "${RUSTFLAGS} -g")
endif()
