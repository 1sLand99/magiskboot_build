From 6697011818e9c539f0367ddf2a626d682b8bf805 Mon Sep 17 00:00:00 2001
From: Ookiineko <chiisaineko@protonmail.com>
Date: Thu, 9 Mar 2023 23:29:40 +0800
Subject: [PATCH] native: fix header includes

Signed-off-by: Ookiineko <chiisaineko@protonmail.com>
---
 native/src/base/files.cpp    |  7 +++++++
 native/src/base/files.hpp    |  3 +++
 native/src/base/logging.hpp  |  4 ++++
 native/src/base/misc.cpp     | 16 ++++++++++++++++
 native/src/base/misc.hpp     |  1 +
 native/src/base/selinux.cpp  |  6 ++++++
 native/src/base/stream.cpp   |  4 ++++
 native/src/base/xwrap.hpp    |  4 ++++
 native/src/boot/format.hpp   |  1 +
 9 files changed, 46 insertions(+)

diff --git a/native/src/base/files.cpp b/native/src/base/files.cpp
index 4012d2e..de7e46c 100644
--- a/native/src/base/files.cpp
+++ b/native/src/base/files.cpp
@@ -1,7 +1,13 @@
 #include <sys/mman.h>
+#ifdef __linux__
 #include <sys/sendfile.h>
 #include <sys/sysmacros.h>
 #include <linux/fs.h>
+#elif defined(__APPLE__)
+#include <sys/types.h>
+#include <sys/disk.h>
+#endif
+#include <sys/ioctl.h>
 #include <fcntl.h>
 #include <unistd.h>
 #include <libgen.h>
diff --git a/native/src/base/files.hpp b/native/src/base/files.hpp
index ea27cfd..9d62e69 100644
--- a/native/src/base/files.hpp
+++ b/native/src/base/files.hpp
@@ -5,7 +5,11 @@
 #include <string>
 #include <vector>
 
+#ifdef __linux__
 #include <linux/fs.h>
+#elif defined(__APPLE__)
+#include <sys/disk.h>
+#endif
 #include "misc.hpp"
 
 template <typename T>
diff --git a/native/src/base/logging.hpp b/native/src/base/logging.hpp
index ac0a3dc..6c370e8 100644
--- a/native/src/base/logging.hpp
+++ b/native/src/base/logging.hpp
@@ -3,6 +3,10 @@
 #include <cerrno>
 #include <cstdarg>
 
+#if !defined(__ANDROID__) && !defined(__APPLE__)
+#include <bsd/sys/cdefs.h>
+#endif
+
 void LOGD(const char *fmt, ...) __printflike(1, 2);
 void LOGI(const char *fmt, ...) __printflike(1, 2);
 void LOGW(const char *fmt, ...) __printflike(1, 2);
diff --git a/native/src/base/misc.cpp b/native/src/base/misc.cpp
index 0dc6189..66f2f9d 100644
--- a/native/src/base/misc.cpp
+++ b/native/src/base/misc.cpp
@@ -1,13 +1,28 @@
 #include <sys/types.h>
 #include <sys/wait.h>
+#ifdef __linux__
 #include <sys/prctl.h>
 #include <sys/sysmacros.h>
+#elif defined(__APPLE__)
+#include <sys/types.h>
+#endif
 #include <fcntl.h>
 #include <pwd.h>
 #include <unistd.h>
+#ifdef __APPLE__
+#include <sys/syscall.h>
+#include <crt_externs.h>
+#define environ (*_NSGetEnviron())
+#include <signal.h>
+#include <pthread.h>
+#else
 #include <syscall.h>
+#endif
 #include <random>
 #include <string>
+#if !defined(__ANDROID__) && !defined(__APPLE__)
+#include <bsd/string.h>
+#endif
 
 #include <base.hpp>
 
diff --git a/native/src/base/selinux.cpp b/native/src/base/selinux.cpp
index dcf3cb0..269d35f 100644
--- a/native/src/base/selinux.cpp
+++ b/native/src/base/selinux.cpp
@@ -1,6 +1,11 @@
 #include <unistd.h>
 #include <sys/syscall.h>
 #include <sys/xattr.h>
+#ifdef __linux__
+#include <linux/xattr.h>
+#else
+#define XATTR_NAME_SELINUX	"security.selinux"
+#endif
 
 #include <base.hpp>
 #include <selinux.hpp>
diff --git a/native/src/base/stream.cpp b/native/src/base/stream.cpp
index dcde87e..8411512 100644
--- a/native/src/base/stream.cpp
+++ b/native/src/base/stream.cpp
@@ -1,5 +1,8 @@
 #include <unistd.h>
 #include <cstddef>
+#if !defined(__ANDROID__) && !defined(__APPLE__)
+#include <bsd/stdio.h>
+#endif
 
 #include <base.hpp>
 #include <stream.hpp>
diff --git a/native/src/base/xwrap.hpp b/native/src/base/xwrap.hpp
index 8c4c1d1..71be943 100644
--- a/native/src/base/xwrap.hpp
+++ b/native/src/base/xwrap.hpp
@@ -4,6 +4,8 @@
 #include <stdio.h>
 #include <poll.h>
 #include <fcntl.h>
+#include <unistd.h>
+#include <sys/socket.h>
 
 #include <base-rs.hpp>
 
@@ -52,7 +54,9 @@ int xmkdir(const char *pathname, mode_t mode);
 int xmkdirs(const char *pathname, mode_t mode);
 int xmkdirat(int dirfd, const char *pathname, mode_t mode);
 void *xmmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
+#ifdef __linux__
 ssize_t xsendfile(int out_fd, int in_fd, off_t *offset, size_t count);
+#endif
 pid_t xfork();
 int xpoll(pollfd *fds, nfds_t nfds, int timeout);
 ssize_t xrealpath(const char * __restrict__ path, char * __restrict__ buf, size_t bufsiz);
-- 
2.40.0

